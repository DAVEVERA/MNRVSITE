<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mijnenveger</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* === MINESWEEPER === */
    body { background: var(--win-bg); }

    .ms-window {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--win-chrome);
      border: 3px solid;
      border-color: var(--win-btn-highlight) var(--win-btn-dark) var(--win-btn-dark) var(--win-btn-highlight);
      box-shadow: inset 1px 1px 0 var(--win-btn-face);
      display: inline-flex;
      flex-direction: column;
      user-select: none;
      max-width: 98vw;
      max-height: calc(100vh - 44px);
    }

    /* Title Bar */
    .ms-titlebar {
      display: flex;
      align-items: center;
      height: 20px;
      padding: 2px 3px;
      background: var(--win-titlebar);
      color: var(--win-titlebar-text);
      font-size: 11px;
      font-weight: bold;
      cursor: default;
      flex-shrink: 0;
    }
    .ms-titlebar-icon {
      width: 16px;
      height: 16px;
      margin-right: 4px;
    }
    .ms-titlebar-title { flex: 1; }
    .ms-titlebar-buttons {
      display: flex;
      gap: 2px;
      margin-left: 4px;
    }

    /* Menu Bar */
    .ms-menubar {
      display: flex;
      align-items: center;
      height: 20px;
      padding: 0 2px;
      background: var(--win-chrome);
      border-bottom: 1px solid var(--win-btn-shadow);
      flex-shrink: 0;
      position: relative;
    }
    .ms-menu-trigger {
      padding: 2px 8px;
      font-size: 11px;
      font-family: var(--font-main);
      cursor: pointer;
      background: none;
      border: none;
      position: relative;
    }
    .ms-menu-trigger:hover,
    .ms-menu-trigger.open {
      background: var(--win-selection-bg);
      color: var(--win-selection-text);
    }

    /* Dropdown Menu */
    .ms-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: var(--win-chrome);
      border: 2px solid;
      border-color: var(--win-btn-highlight) var(--win-btn-dark) var(--win-btn-dark) var(--win-btn-highlight);
      z-index: 1000;
      min-width: 160px;
      padding: 2px 0;
    }
    .ms-dropdown.open { display: block; }
    .ms-dropdown-item {
      display: flex;
      align-items: center;
      padding: 3px 20px 3px 24px;
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap;
      position: relative;
    }
    .ms-dropdown-item:hover {
      background: var(--win-selection-bg);
      color: var(--win-selection-text);
    }
    .ms-dropdown-item .check {
      position: absolute;
      left: 8px;
      font-size: 10px;
    }
    .ms-dropdown-sep {
      height: 2px;
      margin: 2px 4px;
      border-top: 1px solid var(--win-btn-shadow);
      border-bottom: 1px solid var(--win-btn-highlight);
    }

    /* Game Container */
    .ms-game {
      padding: 6px;
      flex-shrink: 0;
    }

    /* Top Panel (counter, smiley, timer) */
    .ms-panel {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 6px;
      margin-bottom: 6px;
      border: 2px solid;
      border-color: var(--win-btn-shadow) var(--win-btn-highlight) var(--win-btn-highlight) var(--win-btn-shadow);
      box-shadow: inset 1px 1px 0 var(--win-btn-dark);
      background: var(--win-chrome);
    }

    /* 7-Segment LED Display */
    .ms-led {
      display: flex;
      background: #000;
      border: 1px solid;
      border-color: var(--win-btn-shadow) var(--win-btn-highlight) var(--win-btn-highlight) var(--win-btn-shadow);
      padding: 1px;
      height: 25px;
    }
    .ms-led-digit {
      width: 13px;
      height: 23px;
      position: relative;
    }
    /* 7-segment paths */
    .ms-led-digit svg { width: 13px; height: 23px; }
    .seg { fill: #300; }
    .seg.on { fill: #f00; }

    /* Smiley Button */
    .ms-smiley {
      width: 26px;
      height: 26px;
      background: var(--win-btn-face);
      border: 2px solid;
      border-color: var(--win-btn-highlight) var(--win-btn-dark) var(--win-btn-dark) var(--win-btn-highlight);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      flex-shrink: 0;
    }
    .ms-smiley:active {
      border-color: var(--win-btn-dark) var(--win-btn-highlight) var(--win-btn-highlight) var(--win-btn-dark);
    }

    /* Minefield */
    .ms-field {
      border: 3px solid;
      border-color: var(--win-btn-shadow) var(--win-btn-highlight) var(--win-btn-highlight) var(--win-btn-shadow);
      box-shadow: inset 1px 1px 0 var(--win-btn-dark);
      display: inline-grid;
      background: var(--win-chrome);
      overflow: auto;
      max-height: calc(100vh - 160px);
    }

    /* Cell */
    .ms-cell {
      width: 16px;
      height: 16px;
      border: 1px solid;
      border-color: var(--win-btn-highlight) var(--win-btn-shadow) var(--win-btn-shadow) var(--win-btn-highlight);
      background: var(--win-chrome);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-family: var(--font-main);
      font-size: 11px;
      font-weight: bold;
      line-height: 1;
      box-sizing: border-box;
    }
    .ms-cell.raised {
      border-width: 2px;
      border-color: var(--win-btn-highlight) var(--win-btn-dark) var(--win-btn-dark) var(--win-btn-highlight);
    }
    .ms-cell.revealed {
      border: 1px solid #808080;
      border-right-color: #c0c0c0;
      border-bottom-color: #c0c0c0;
      cursor: default;
    }
    .ms-cell.mine-hit {
      background: #ff0000;
    }
    .ms-cell.mine-wrong {
      background: var(--win-chrome);
    }

    /* Number colors - authentic Win95 */
    .ms-cell.n1 { color: #0000ff; }
    .ms-cell.n2 { color: #008000; }
    .ms-cell.n3 { color: #ff0000; }
    .ms-cell.n4 { color: #000080; }
    .ms-cell.n5 { color: #800000; }
    .ms-cell.n6 { color: #008080; }
    .ms-cell.n7 { color: #000000; }
    .ms-cell.n8 { color: #808080; }

    /* Cell content SVGs */
    .ms-cell svg {
      width: 12px;
      height: 12px;
      display: block;
    }

    /* Taskbar page */
    .page-desktop { display: flex; flex-direction: column; }
  </style>
</head>
<body>

<div class="page-desktop">

  <div class="ms-window" id="ms-window">
    <!-- Title Bar -->
    <div class="ms-titlebar">
      <svg class="ms-titlebar-icon" viewBox="0 0 16 16">
        <circle cx="8" cy="8" r="5" fill="#000" stroke="#808080" stroke-width="1"/>
        <line x1="4" y1="4" x2="6" y2="6" stroke="#000" stroke-width="1.5"/>
        <line x1="12" y1="4" x2="10" y2="6" stroke="#000" stroke-width="1.5"/>
        <line x1="8" y1="1" x2="8" y2="3" stroke="#000" stroke-width="1.5"/>
        <line x1="8" y1="13" x2="8" y2="15" stroke="#000" stroke-width="1.5"/>
        <line x1="1" y1="8" x2="3" y2="8" stroke="#000" stroke-width="1.5"/>
        <line x1="13" y1="8" x2="15" y2="8" stroke="#000" stroke-width="1.5"/>
        <circle cx="8" cy="8" r="2" fill="#808080"/>
      </svg>
      <span class="ms-titlebar-title">Mijnenveger</span>
      <div class="ms-titlebar-buttons">
        <button class="win-titlebar-btn min-btn" title="Minimaliseren">_</button>
        <button class="win-titlebar-btn max-btn" title="Maximaliseren">&#9633;</button>
        <a href="index.html" class="win-titlebar-btn close-btn" title="Sluiten" style="text-decoration:none;color:inherit;">X</a>
      </div>
    </div>

    <!-- Menu Bar -->
    <div class="ms-menubar" id="ms-menubar">
      <button class="ms-menu-trigger" id="menu-game-btn">Spel</button>
      <div class="ms-dropdown" id="menu-game">
        <div class="ms-dropdown-item" onclick="MS.newGame()">Nieuw</div>
        <div class="ms-dropdown-sep"></div>
        <div class="ms-dropdown-item" data-diff="beginner"><span class="check"></span>Beginner</div>
        <div class="ms-dropdown-item" data-diff="intermediate"><span class="check"></span>Gemiddeld</div>
        <div class="ms-dropdown-item" data-diff="expert"><span class="check"></span>Expert</div>
        <div class="ms-dropdown-sep"></div>
        <div class="ms-dropdown-item" onclick="MS.toggleMarks()"><span class="check" id="marks-check"></span>Vraagtekens</div>
        <div class="ms-dropdown-sep"></div>
        <div class="ms-dropdown-item" id="best-times-btn">Beste tijden...</div>
        <div class="ms-dropdown-sep"></div>
        <div class="ms-dropdown-item" onclick="window.location.href='index.html'">Afsluiten</div>
      </div>

      <button class="ms-menu-trigger" id="menu-help-btn">Help</button>
      <div class="ms-dropdown" id="menu-help">
        <div class="ms-dropdown-item" onclick="MS.showAbout()">Over Mijnenveger...</div>
      </div>
    </div>

    <!-- Game Area -->
    <div class="ms-game">
      <!-- Top Panel -->
      <div class="ms-panel">
        <div class="ms-led" id="mine-counter"></div>
        <button class="ms-smiley" id="smiley-btn" title="Nieuw spel"></button>
        <div class="ms-led" id="timer-display"></div>
      </div>

      <!-- Minefield -->
      <div class="ms-field" id="minefield"></div>
    </div>
  </div>

  <!-- Taskbar -->
  <div class="taskbar">
    <a href="index.html" class="start-btn" style="text-decoration:none;color:inherit;">
      <span style="display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:1px;width:16px;height:16px;transform:skewX(-5deg);">
        <span style="background:#ff0000;"></span><span style="background:#00aa00;"></span><span style="background:#0000ff;"></span><span style="background:#ffcc00;"></span>
      </span>
      <span>Start</span>
    </a>
    <div class="taskbar-windows" style="flex:1;">
      <button class="taskbar-window-btn active">Mijnenveger</button>
    </div>
    <div class="system-tray">
      <span id="tray-clock" class="tray-clock">00:00</span>
    </div>
  </div>

</div>

<script>
(function() {
  'use strict';

  // ============================================
  // CONFIG
  // ============================================
  var DIFFICULTIES = {
    beginner:     { rows: 9,  cols: 9,  mines: 10 },
    intermediate: { rows: 16, cols: 16, mines: 40 },
    expert:       { rows: 16, cols: 30, mines: 99 }
  };

  // ============================================
  // STATE
  // ============================================
  var difficulty = 'beginner';
  var rows, cols, totalMines;
  var board = [];       // 2D: { mine, revealed, flagged, question, adjacent }
  var gameState = 'idle'; // idle, playing, won, lost
  var minesPlaced = false;
  var flagCount = 0;
  var timer = 0;
  var timerInterval = null;
  var useQuestionMarks = true;
  var mouseDownOnField = false;

  // Best times
  var bestTimes = { beginner: 999, intermediate: 999, expert: 999 };
  try {
    var saved = localStorage.getItem('ms-best');
    if (saved) bestTimes = JSON.parse(saved);
  } catch(e) {}

  // ============================================
  // 7-SEGMENT LED DISPLAY
  // ============================================
  //   0
  // 1   2
  //   3
  // 4   5
  //   6
  var SEGMENTS = {
    0: [1,1,1,0,1,1,1],
    1: [0,0,1,0,0,1,0],
    2: [1,0,1,1,1,0,1],
    3: [1,0,1,1,0,1,1],
    4: [0,1,1,1,0,1,0],
    5: [1,1,0,1,0,1,1],
    6: [1,1,0,1,1,1,1],
    7: [1,0,1,0,0,1,0],
    8: [1,1,1,1,1,1,1],
    9: [1,1,1,1,0,1,1],
    '-': [0,0,0,1,0,0,0],
    ' ': [0,0,0,0,0,0,0]
  };

  function renderLED(containerId, value) {
    var el = document.getElementById(containerId);
    if (!el) return;
    var str = String(value);
    // Pad/truncate to 3 chars
    if (value < 0) {
      str = '-' + String(Math.abs(value)).padStart(2, '0');
    } else {
      str = String(value).padStart(3, '0');
    }
    if (str.length > 3) str = str.slice(0, 3);

    var html = '';
    for (var i = 0; i < 3; i++) {
      var ch = str[i];
      var segs = SEGMENTS[ch] || SEGMENTS[' '];
      html += '<div class="ms-led-digit"><svg viewBox="0 0 13 23">' +
        '<polygon class="seg' + (segs[0] ? ' on' : '') + '" points="2,1 11,1 10,3 3,3"/>' +     // top
        '<polygon class="seg' + (segs[1] ? ' on' : '') + '" points="1,2 3,4 3,10 1,11"/>' +     // top-left
        '<polygon class="seg' + (segs[2] ? ' on' : '') + '" points="12,2 12,11 10,10 10,4"/>' +  // top-right
        '<polygon class="seg' + (segs[3] ? ' on' : '') + '" points="2,11 3,10 10,10 11,11 10,12 3,12"/>' + // middle
        '<polygon class="seg' + (segs[4] ? ' on' : '') + '" points="1,12 3,13 3,19 1,21"/>' +   // bottom-left
        '<polygon class="seg' + (segs[5] ? ' on' : '') + '" points="12,12 12,21 10,19 10,13"/>' +// bottom-right
        '<polygon class="seg' + (segs[6] ? ' on' : '') + '" points="2,22 3,20 10,20 11,22"/>' +  // bottom
        '</svg></div>';
    }
    el.innerHTML = html;
  }

  // ============================================
  // SMILEY FACE
  // ============================================
  function setSmiley(state) {
    var btn = document.getElementById('smiley-btn');
    if (!btn) return;
    var svg = '';
    switch(state) {
      case 'happy':
        svg = '<svg viewBox="0 0 20 20" width="20" height="20">' +
          '<circle cx="10" cy="10" r="9" fill="#ffcc00" stroke="#000" stroke-width="1"/>' +
          '<rect x="6" y="7" width="2" height="2" fill="#000"/>' +
          '<rect x="12" y="7" width="2" height="2" fill="#000"/>' +
          '<path d="M6 12 Q10 16 14 12" fill="none" stroke="#000" stroke-width="1"/>' +
          '</svg>';
        break;
      case 'pressed':
        svg = '<svg viewBox="0 0 20 20" width="20" height="20">' +
          '<circle cx="10" cy="10" r="9" fill="#ffcc00" stroke="#000" stroke-width="1"/>' +
          '<circle cx="7" cy="8" r="2" fill="none" stroke="#000" stroke-width="1"/>' +
          '<circle cx="13" cy="8" r="2" fill="none" stroke="#000" stroke-width="1"/>' +
          '<circle cx="10" cy="13" r="2" fill="none" stroke="#000" stroke-width="1"/>' +
          '</svg>';
        break;
      case 'dead':
        svg = '<svg viewBox="0 0 20 20" width="20" height="20">' +
          '<circle cx="10" cy="10" r="9" fill="#ffcc00" stroke="#000" stroke-width="1"/>' +
          '<line x1="5" y1="6" x2="8" y2="9" stroke="#000" stroke-width="1.2"/>' +
          '<line x1="8" y1="6" x2="5" y2="9" stroke="#000" stroke-width="1.2"/>' +
          '<line x1="12" y1="6" x2="15" y2="9" stroke="#000" stroke-width="1.2"/>' +
          '<line x1="15" y1="6" x2="12" y2="9" stroke="#000" stroke-width="1.2"/>' +
          '<path d="M6 14 Q10 11 14 14" fill="none" stroke="#000" stroke-width="1"/>' +
          '</svg>';
        break;
      case 'cool':
        svg = '<svg viewBox="0 0 20 20" width="20" height="20">' +
          '<circle cx="10" cy="10" r="9" fill="#ffcc00" stroke="#000" stroke-width="1"/>' +
          '<rect x="4" y="7" width="5" height="3" rx="1" fill="#000"/>' +
          '<rect x="11" y="7" width="5" height="3" rx="1" fill="#000"/>' +
          '<line x1="9" y1="8.5" x2="11" y2="8.5" stroke="#000" stroke-width="1"/>' +
          '<path d="M6 13 Q10 16 14 13" fill="none" stroke="#000" stroke-width="1"/>' +
          '</svg>';
        break;
    }
    btn.innerHTML = svg;
  }

  // ============================================
  // CELL RENDERING
  // ============================================
  function getMineIcon() {
    return '<svg viewBox="0 0 12 12"><circle cx="6" cy="6" r="3.5" fill="#000"/>' +
      '<line x1="6" y1="1" x2="6" y2="11" stroke="#000" stroke-width="1"/>' +
      '<line x1="1" y1="6" x2="11" y2="6" stroke="#000" stroke-width="1"/>' +
      '<line x1="2.5" y1="2.5" x2="9.5" y2="9.5" stroke="#000" stroke-width="1"/>' +
      '<line x1="9.5" y1="2.5" x2="2.5" y2="9.5" stroke="#000" stroke-width="1"/>' +
      '<rect x="4.5" y="3.5" width="1.5" height="1.5" fill="#fff" rx="0.3"/></svg>';
  }

  function getFlagIcon() {
    return '<svg viewBox="0 0 12 12">' +
      '<polygon points="3,2 3,8 9,5" fill="#ff0000" stroke="#800000" stroke-width="0.5"/>' +
      '<line x1="3" y1="2" x2="3" y2="10" stroke="#000" stroke-width="1.2"/>' +
      '<line x1="1" y1="10" x2="6" y2="10" stroke="#000" stroke-width="1.5"/></svg>';
  }

  function getQuestionIcon() {
    return '<span style="color:#000;font-size:12px;font-weight:bold;">?</span>';
  }

  function getWrongMineIcon() {
    return '<svg viewBox="0 0 12 12"><circle cx="6" cy="6" r="3.5" fill="#000"/>' +
      '<line x1="6" y1="1" x2="6" y2="11" stroke="#000" stroke-width="1"/>' +
      '<line x1="1" y1="6" x2="11" y2="6" stroke="#000" stroke-width="1"/>' +
      '<line x1="2.5" y1="2.5" x2="9.5" y2="9.5" stroke="#000" stroke-width="1"/>' +
      '<line x1="9.5" y1="2.5" x2="2.5" y2="9.5" stroke="#000" stroke-width="1"/>' +
      '<rect x="4.5" y="3.5" width="1.5" height="1.5" fill="#fff" rx="0.3"/>' +
      '<line x1="1" y1="1" x2="11" y2="11" stroke="#ff0000" stroke-width="1.5"/>' +
      '<line x1="11" y1="1" x2="1" y2="11" stroke="#ff0000" stroke-width="1.5"/></svg>';
  }

  function renderCell(r, c) {
    var cell = board[r][c];
    var el = cell.el;
    if (!el) return;

    el.className = 'ms-cell';
    el.innerHTML = '';

    if (cell.revealed) {
      el.classList.add('revealed');
      if (cell.mine) {
        el.innerHTML = getMineIcon();
        if (cell.hit) {
          el.classList.add('mine-hit');
        }
      } else if (cell.adjacent > 0) {
        el.classList.add('n' + cell.adjacent);
        el.textContent = cell.adjacent;
      }
    } else if (cell.flagged) {
      el.classList.add('raised');
      if (gameState === 'lost' && !cell.mine) {
        // Wrong flag
        el.classList.add('revealed');
        el.classList.remove('raised');
        el.classList.add('mine-wrong');
        el.innerHTML = getWrongMineIcon();
      } else {
        el.innerHTML = getFlagIcon();
      }
    } else if (cell.question) {
      el.classList.add('raised');
      el.innerHTML = getQuestionIcon();
    } else {
      el.classList.add('raised');
      // Show unrevealed mines on loss
      if (gameState === 'lost' && cell.mine) {
        el.classList.add('revealed');
        el.classList.remove('raised');
        el.innerHTML = getMineIcon();
      }
    }
  }

  // ============================================
  // BOARD SETUP
  // ============================================
  function initBoard() {
    var cfg = DIFFICULTIES[difficulty];
    rows = cfg.rows;
    cols = cfg.cols;
    totalMines = cfg.mines;
    board = [];
    flagCount = 0;
    gameState = 'idle';
    minesPlaced = false;
    timer = 0;
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }

    // Create board data
    for (var r = 0; r < rows; r++) {
      board[r] = [];
      for (var c = 0; c < cols; c++) {
        board[r][c] = {
          mine: false,
          revealed: false,
          flagged: false,
          question: false,
          adjacent: 0,
          hit: false,
          el: null
        };
      }
    }

    // Render field
    var field = document.getElementById('minefield');
    field.style.gridTemplateColumns = 'repeat(' + cols + ', 16px)';
    field.style.gridTemplateRows = 'repeat(' + rows + ', 16px)';
    field.innerHTML = '';

    for (var r = 0; r < rows; r++) {
      for (var c = 0; c < cols; c++) {
        var el = document.createElement('div');
        el.className = 'ms-cell raised';
        el.setAttribute('data-r', r);
        el.setAttribute('data-c', c);
        board[r][c].el = el;
        field.appendChild(el);
      }
    }

    renderLED('mine-counter', totalMines);
    renderLED('timer-display', 0);
    setSmiley('happy');
    updateDifficultyChecks();
  }

  function placeMines(safeR, safeC) {
    var placed = 0;
    while (placed < totalMines) {
      var r = Math.floor(Math.random() * rows);
      var c = Math.floor(Math.random() * cols);
      // Keep safe zone around first click
      if (Math.abs(r - safeR) <= 1 && Math.abs(c - safeC) <= 1) continue;
      if (board[r][c].mine) continue;
      board[r][c].mine = true;
      placed++;
    }

    // Calculate adjacency
    for (var r = 0; r < rows; r++) {
      for (var c = 0; c < cols; c++) {
        if (board[r][c].mine) continue;
        var count = 0;
        forNeighbors(r, c, function(nr, nc) {
          if (board[nr][nc].mine) count++;
        });
        board[r][c].adjacent = count;
      }
    }

    minesPlaced = true;
  }

  function forNeighbors(r, c, fn) {
    for (var dr = -1; dr <= 1; dr++) {
      for (var dc = -1; dc <= 1; dc++) {
        if (dr === 0 && dc === 0) continue;
        var nr = r + dr;
        var nc = c + dc;
        if (nr >= 0 && nr < rows && nc >= 0 && nc < cols) {
          fn(nr, nc);
        }
      }
    }
  }

  // ============================================
  // GAME LOGIC
  // ============================================
  function reveal(r, c) {
    var cell = board[r][c];
    if (cell.revealed || cell.flagged) return;

    if (!minesPlaced) {
      placeMines(r, c);
      startTimer();
      gameState = 'playing';
    }

    cell.revealed = true;
    cell.question = false;

    if (cell.mine) {
      cell.hit = true;
      gameOver(false);
      return;
    }

    // Flood fill for empty cells
    if (cell.adjacent === 0) {
      forNeighbors(r, c, function(nr, nc) {
        if (!board[nr][nc].revealed && !board[nr][nc].flagged) {
          reveal(nr, nc);
        }
      });
    }

    renderCell(r, c);
    checkWin();
  }

  function toggleFlag(r, c) {
    var cell = board[r][c];
    if (cell.revealed) return;
    if (gameState === 'idle') {
      gameState = 'playing';
      startTimer();
    }
    if (gameState !== 'playing') return;

    if (!cell.flagged && !cell.question) {
      cell.flagged = true;
      flagCount++;
    } else if (cell.flagged) {
      cell.flagged = false;
      flagCount--;
      if (useQuestionMarks) {
        cell.question = true;
      }
    } else if (cell.question) {
      cell.question = false;
    }

    renderCell(r, c);
    renderLED('mine-counter', totalMines - flagCount);
  }

  function chord(r, c) {
    var cell = board[r][c];
    if (!cell.revealed || cell.adjacent === 0) return;

    // Count adjacent flags
    var adjFlags = 0;
    forNeighbors(r, c, function(nr, nc) {
      if (board[nr][nc].flagged) adjFlags++;
    });

    if (adjFlags === cell.adjacent) {
      forNeighbors(r, c, function(nr, nc) {
        if (!board[nr][nc].revealed && !board[nr][nc].flagged) {
          reveal(nr, nc);
        }
      });
    }
  }

  function checkWin() {
    if (gameState !== 'playing') return;
    var unrevealed = 0;
    for (var r = 0; r < rows; r++) {
      for (var c = 0; c < cols; c++) {
        if (!board[r][c].revealed) unrevealed++;
      }
    }
    if (unrevealed === totalMines) {
      gameOver(true);
    }
  }

  function gameOver(won) {
    gameState = won ? 'won' : 'lost';
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }

    if (won) {
      setSmiley('cool');
      // Auto-flag all mines
      for (var r = 0; r < rows; r++) {
        for (var c = 0; c < cols; c++) {
          if (board[r][c].mine && !board[r][c].flagged) {
            board[r][c].flagged = true;
            flagCount++;
          }
          renderCell(r, c);
        }
      }
      renderLED('mine-counter', 0);
      // Check best time
      if (timer < bestTimes[difficulty]) {
        bestTimes[difficulty] = timer;
        try { localStorage.setItem('ms-best', JSON.stringify(bestTimes)); } catch(e) {}
      }
    } else {
      setSmiley('dead');
      // Reveal all cells (mines shown, wrong flags marked)
      for (var r = 0; r < rows; r++) {
        for (var c = 0; c < cols; c++) {
          renderCell(r, c);
        }
      }
    }
  }

  // ============================================
  // TIMER
  // ============================================
  function startTimer() {
    if (timerInterval) return;
    timer = 0;
    timerInterval = setInterval(function() {
      timer++;
      if (timer > 999) timer = 999;
      renderLED('timer-display', timer);
    }, 1000);
  }

  // ============================================
  // EVENT HANDLERS
  // ============================================
  function initEvents() {
    var field = document.getElementById('minefield');

    // Prevent context menu on field
    field.addEventListener('contextmenu', function(e) {
      e.preventDefault();
    });

    // Mouse down - show pressed smiley
    field.addEventListener('mousedown', function(e) {
      var cell = e.target.closest('.ms-cell');
      if (!cell) return;
      if (gameState === 'won' || gameState === 'lost') return;

      if (e.button === 0) {
        mouseDownOnField = true;
        if (gameState === 'idle' || gameState === 'playing') {
          setSmiley('pressed');
        }
      }

      if (e.button === 2) {
        var r = parseInt(cell.getAttribute('data-r'));
        var c = parseInt(cell.getAttribute('data-c'));
        toggleFlag(r, c);
      }
    });

    // Mouse up - reveal cell
    field.addEventListener('mouseup', function(e) {
      var cell = e.target.closest('.ms-cell');
      if (!cell) return;
      if (gameState === 'won' || gameState === 'lost') return;

      var r = parseInt(cell.getAttribute('data-r'));
      var c = parseInt(cell.getAttribute('data-c'));

      if (e.button === 0 && mouseDownOnField) {
        mouseDownOnField = false;
        if (gameState !== 'lost' && gameState !== 'won') {
          setSmiley('happy');
        }
        reveal(r, c);
      }

      // Middle click or both buttons = chord
      if (e.button === 1) {
        chord(r, c);
      }
    });

    // Double click = chord
    field.addEventListener('dblclick', function(e) {
      var cell = e.target.closest('.ms-cell');
      if (!cell) return;
      if (gameState !== 'playing') return;
      var r = parseInt(cell.getAttribute('data-r'));
      var c = parseInt(cell.getAttribute('data-c'));
      chord(r, c);
    });

    // Global mouseup to reset smiley
    document.addEventListener('mouseup', function() {
      if (mouseDownOnField) {
        mouseDownOnField = false;
        if (gameState === 'idle' || gameState === 'playing') {
          setSmiley('happy');
        }
      }
    });

    // Smiley button
    document.getElementById('smiley-btn').addEventListener('click', function() {
      initBoard();
    });

    // Menu handling
    var gameBtn = document.getElementById('menu-game-btn');
    var gameMenu = document.getElementById('menu-game');
    var helpBtn = document.getElementById('menu-help-btn');
    var helpMenu = document.getElementById('menu-help');
    var menuOpen = null;

    function closeMenus() {
      gameMenu.classList.remove('open');
      helpMenu.classList.remove('open');
      gameBtn.classList.remove('open');
      helpBtn.classList.remove('open');
      menuOpen = null;
    }

    gameBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (menuOpen === 'game') { closeMenus(); return; }
      closeMenus();
      gameMenu.classList.add('open');
      gameBtn.classList.add('open');
      menuOpen = 'game';
    });

    helpBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (menuOpen === 'help') { closeMenus(); return; }
      closeMenus();
      helpMenu.classList.add('open');
      helpBtn.classList.add('open');
      menuOpen = 'help';
    });

    // Hover between menus when one is open
    gameBtn.addEventListener('mouseenter', function() {
      if (menuOpen && menuOpen !== 'game') {
        closeMenus();
        gameMenu.classList.add('open');
        gameBtn.classList.add('open');
        menuOpen = 'game';
      }
    });
    helpBtn.addEventListener('mouseenter', function() {
      if (menuOpen && menuOpen !== 'help') {
        closeMenus();
        helpMenu.classList.add('open');
        helpBtn.classList.add('open');
        menuOpen = 'help';
      }
    });

    document.addEventListener('click', function(e) {
      if (menuOpen && !e.target.closest('.ms-menubar')) {
        closeMenus();
      }
    });

    // Difficulty items
    var diffItems = gameMenu.querySelectorAll('[data-diff]');
    diffItems.forEach(function(item) {
      item.addEventListener('click', function() {
        difficulty = item.getAttribute('data-diff');
        closeMenus();
        initBoard();
      });
    });

    // Best times
    document.getElementById('best-times-btn').addEventListener('click', function() {
      closeMenus();
      showBestTimes();
    });

    // Touch support for mobile
    field.addEventListener('touchstart', function(e) {
      var cell = e.target.closest('.ms-cell');
      if (!cell) return;
      if (gameState === 'won' || gameState === 'lost') return;
      e.preventDefault();

      var r = parseInt(cell.getAttribute('data-r'));
      var c = parseInt(cell.getAttribute('data-c'));

      setSmiley('pressed');

      // Long press = flag
      cell._longPress = setTimeout(function() {
        cell._longPress = null;
        toggleFlag(r, c);
        if (gameState === 'idle' || gameState === 'playing') setSmiley('happy');
      }, 400);
    }, { passive: false });

    field.addEventListener('touchend', function(e) {
      var cell = e.target.closest('.ms-cell');
      if (!cell) return;
      if (gameState === 'won' || gameState === 'lost') return;
      e.preventDefault();

      var r = parseInt(cell.getAttribute('data-r'));
      var c = parseInt(cell.getAttribute('data-c'));

      if (cell._longPress) {
        clearTimeout(cell._longPress);
        cell._longPress = null;
        reveal(r, c);
      }

      if (gameState !== 'lost' && gameState !== 'won') {
        setSmiley('happy');
      }
    }, { passive: false });

    field.addEventListener('touchmove', function(e) {
      var cell = e.target.closest('.ms-cell');
      if (cell && cell._longPress) {
        clearTimeout(cell._longPress);
        cell._longPress = null;
      }
      if (gameState === 'idle' || gameState === 'playing') setSmiley('happy');
    });
  }

  // ============================================
  // MENUS
  // ============================================
  function updateDifficultyChecks() {
    var items = document.querySelectorAll('[data-diff]');
    items.forEach(function(item) {
      var check = item.querySelector('.check');
      check.textContent = item.getAttribute('data-diff') === difficulty ? '\u2713' : '';
    });
    var marksCheck = document.getElementById('marks-check');
    if (marksCheck) marksCheck.textContent = useQuestionMarks ? '\u2713' : '';
  }

  function showBestTimes() {
    var msg = 'Beste tijden:\n\n' +
      'Beginner:\t' + (bestTimes.beginner < 999 ? bestTimes.beginner + ' sec' : '---') + '\n' +
      'Gemiddeld:\t' + (bestTimes.intermediate < 999 ? bestTimes.intermediate + ' sec' : '---') + '\n' +
      'Expert:\t\t' + (bestTimes.expert < 999 ? bestTimes.expert + ' sec' : '---');
    alert(msg);
  }

  // ============================================
  // PUBLIC API
  // ============================================
  window.MS = {
    newGame: function() {
      document.querySelectorAll('.ms-dropdown').forEach(function(m) { m.classList.remove('open'); });
      document.querySelectorAll('.ms-menu-trigger').forEach(function(m) { m.classList.remove('open'); });
      initBoard();
    },
    toggleMarks: function() {
      useQuestionMarks = !useQuestionMarks;
      updateDifficultyChecks();
      document.querySelectorAll('.ms-dropdown').forEach(function(m) { m.classList.remove('open'); });
      document.querySelectorAll('.ms-menu-trigger').forEach(function(m) { m.classList.remove('open'); });
    },
    showAbout: function() {
      document.querySelectorAll('.ms-dropdown').forEach(function(m) { m.classList.remove('open'); });
      document.querySelectorAll('.ms-menu-trigger').forEach(function(m) { m.classList.remove('open'); });
      alert('Mijnenveger\n\nKlassiek Windows spel\nNagemaakt voor MNRV\n\n\u00A9 2026 MNRV');
    }
  };

  // ============================================
  // CLOCK
  // ============================================
  function updateClock() {
    var el = document.getElementById('tray-clock');
    if (!el) return;
    var now = new Date();
    el.textContent = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
  }
  updateClock();
  setInterval(updateClock, 10000);

  // ============================================
  // INIT
  // ============================================
  initBoard();
  initEvents();

})();
</script>

</body>
</html>
